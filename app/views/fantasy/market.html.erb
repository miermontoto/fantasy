<% content_for :title, "Mercado" %>

<div class="container mx-auto p-4 h-[calc(100vh-6rem)] flex flex-col"
     data-controller="fantasy--market">
  <!-- General Info Container -->
  <div class="bg-gray-800 rounded-lg p-4 mb-6">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div class="flex items-center gap-6">
        <div>
          <span class="text-gray-400 text-sm">Balance</span>
          <p class="text-xl font-semibold <%= @market_data[:info][:current_balance].to_i < 0 ? 'text-red-500' : 'text-white' %>">
            <%= number_to_currency(@market_data[:info][:current_balance], unit: '€', precision: 0) %>
          </p>
        </div>
        <div class="h-8 w-px bg-gray-700"></div>
        <div>
          <span class="text-gray-400 text-sm">Balance Futuro</span>
          <p class="text-xl font-semibold <%= @market_data[:info][:future_balance].to_i < 0 ? 'text-red-500' : 'text-white' %>">
            <%= number_to_currency(@market_data[:info][:future_balance], unit: '€', precision: 0) %>
          </p>
        </div>
        <div class="h-8 w-px bg-gray-700"></div>
        <div>
          <span class="text-gray-400 text-sm">Deuda Máxima</span>
          <p class="text-xl font-semibold <%= @market_data[:info][:max_debt].to_i < 0 ? 'text-red-500' : 'text-white' %>">
            <%= number_to_currency(@market_data[:info][:max_debt], unit: '€', precision: 0) %>
          </p>
        </div>
      </div>
      <div>
        <span class="text-gray-400 text-sm">Próxima Actualización</span>
        <p class="text-lg font-semibold"><%= @market_data[:info][:next_update] %></p>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 flex-1 min-h-0">
    <!-- Filters Sidebar -->
    <div class="lg:col-span-1">
      <div class="bg-gray-800 rounded-lg p-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Filtros</h3>
          <% if params[:position].present? || params[:exclude_position].present? ||
                params[:max_price].present? && params[:max_price].to_i != 100_000_000 ||
                params[:sort_by].present? && params[:sort_by] != 'points' ||
                params[:sort_direction].present? && params[:sort_direction] != 'desc' ||
                params[:search].present? %>
            <%= link_to market_path, class: "text-blue-400 hover:text-blue-300 text-sm", data: { turbo_frame: "market-content" } do %>
              Limpiar filtros
              <span class="ml-1">×</span>
            <% end %>
          <% end %>
        </div>

        <%= form_tag market_path, method: :get,
            class: "space-y-4",
            data: {
              turbo_frame: "market-content",
              fantasy__market_target: "form"
            } do %>
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Posición</label>
            <div class="flex gap-2">
              <% positions = [
                ['POR', { color: 'bg-yellow-500 border-yellow-500', text: 'text-black' }],
                ['DEF', { color: 'bg-blue-500 border-blue-500', text: 'text-black' }],
                ['MED', { color: 'bg-green-500 border-green-500', text: 'text-black' }],
                ['DEL', { color: 'bg-red-500 border-red-500', text: 'text-black' }]
              ] %>
              <% positions.each do |pos, styles| %>
                <% is_selected = params[:position] == pos %>
                <% is_excluded = params[:exclude_position]&.split(',')&.include?(pos) %>
                <button type="button"
                        data-position="<%= pos %>"
                        data-action="click->fantasy--market#togglePosition"
                        class="relative flex-1 px-3 py-1.5 border-2 text-sm font-bold rounded skew-x-[-10deg] transition-all
                               <%= is_selected ? styles[:color] : is_excluded ? 'bg-gray-700 border-gray-600 opacity-40' : 'bg-gray-700 border-gray-600 hover:border-gray-500' %>">
                  <span class="block skew-x-[10deg] <%= is_selected ? styles[:text] : 'text-white' %>"><%= pos %></span>
                  <% if is_excluded %>
                    <div class="absolute inset-0 flex items-center justify-center skew-x-[10deg]">
                      <div class="w-full h-0.5 bg-gray-300 rotate-45"></div>
                    </div>
                  <% end %>
                </button>
              <% end %>
              <%= hidden_field_tag :position, params[:position] %>
              <%= hidden_field_tag :exclude_position, params[:exclude_position] %>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">
              Precio Máximo: <span id="price-value"><%= number_to_currency(params[:max_price] || 100_000_000, unit: '€', precision: 0) %></span>
            </label>
            <%= range_field_tag :max_price,
              params[:max_price] || 100_000_000,
              min: 0,
              max: 100_000_000,
              step: 1_000_000,
              class: "w-full",
              data: { action: "input->fantasy--market#updatePriceDisplay change->fantasy--market#submitForm" }
            %>
            <div class="flex justify-between text-sm text-gray-400 mt-1">
              <span>0€</span>
              <span>100M€</span>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Ordenar por</label>
            <div class="flex gap-2">
              <%= select_tag :sort_by,
                options_for_select([
                  ['Puntos', 'points'],
                  ['Media', 'avg'],
                  ['PPM', 'ppm'],
                  ['Precio', 'price'],
                  ['Racha', 'streak']
                ], params[:sort_by] || 'points'),
                class: "flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",
                data: { action: "change->fantasy--market#submitForm" }
              %>

              <button type="button"
                      data-action="click->fantasy--market#toggleSortDirection"
                      class="px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <span class="text-xl leading-none">
                  <%= params[:sort_direction] == 'asc' ? '↑' : '↓' %>
                </span>
              </button>
              <%= hidden_field_tag :sort_direction, params[:sort_direction] || 'desc' %>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Buscar jugador</label>
            <%= text_field_tag :search,
              params[:search],
              placeholder: "Nombre del jugador...",
              class: "w-full px-4 py-2 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
              data: { action: "input->fantasy--market#submitForm" }
            %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Results Container -->
    <div class="lg:col-span-3 bg-gray-800 rounded-lg flex flex-col min-h-0">
      <div class="p-4 border-b border-gray-700">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold">Jugadores en el Mercado</h2>
        </div>
      </div>

      <%= turbo_frame_tag "market-content", class: "flex flex-col flex-1" do %>
        <%= render partial: "fantasy/partials/market_content", locals: {
          market_players: @filtered_market,
          page: @page,
          total_pages: @total_pages
        } %>
      <% end %>
    </div>
  </div>
</div>
